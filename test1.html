<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OCR 去除水滴或污渍</title>
    <style>
        canvas {
            display: block;
            margin: 20px auto;
            max-width: 100%;
            height: auto;
            border: 1px solid #ddd;
        }
        pre {
            background-color: #f4f4f4;
            padding: 10px;
            border: 1px solid #ddd;
            white-space: pre-wrap;
        }
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 10px;
        }
    </style>
</head>
<body>
    <h1>选择本地图片进行处理</h1>
    <input type="file" id="fileInput" accept="image/*">

    <h1>原图</h1>
    <canvas id="canvas"></canvas>
    
    <h1>灰度化 + 去污渍结果</h1>
    <canvas id="processedCanvas"></canvas>

    <h1>二值化结果</h1>
    <canvas id="binaryCanvas"></canvas>

    <h2>识别出的文字</h2>
    <pre id="textResult">等待识别...</pre>

    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@2.1.1/dist/tesseract.min.js"></script>
    <script>
        const fileInput = document.getElementById('fileInput');
        const canvas = document.getElementById('canvas');
        const processedCanvas = document.getElementById('processedCanvas');
        const binaryCanvas = document.getElementById('binaryCanvas');
        const ctx = canvas.getContext('2d');
        const processedCtx = processedCanvas.getContext('2d');
        const binaryCtx = binaryCanvas.getContext('2d');
        const textResult = document.getElementById('textResult');

        fileInput.addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();

                reader.onload = () => {
                    const image = new Image();
                    image.src = reader.result;

                    image.onload = async () => {
                        canvas.width = processedCanvas.width = binaryCanvas.width = image.width;
                        canvas.height = processedCanvas.height = binaryCanvas.height = image.height;

                        // 绘制原始图像
                        ctx.drawImage(image, 0, 0, canvas.width, canvas.height);

                        // 图像去污渍和灰度化处理
                        processedCtx.drawImage(image, 0, 0, processedCanvas.width, processedCanvas.height);
                        removeArtifacts(processedCanvas);

                        // 二值化处理
                        binaryCtx.drawImage(processedCanvas, 0, 0, binaryCanvas.width, binaryCanvas.height);
                        binarizeImage(binaryCanvas);

                        // OCR 文字识别
                        textResult.textContent = '正在识别文字，请稍候...';
                        const recognizedText = await extractText(binaryCanvas);
                        textResult.textContent = `识别结果：\n${recognizedText}`;
                    };
                };

                reader.readAsDataURL(file);
            }
        });

        // 去除水滴和污渍
        function removeArtifacts(canvas) {
            const ctx = canvas.getContext('2d');
            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            const data = imageData.data;

            for (let i = 0; i < data.length; i += 4) {
                const r = data[i];
                const g = data[i + 1];
                const b = data[i + 2];
                const brightness = 0.299 * r + 0.587 * g + 0.114 * b;

                if (brightness > 200) { // 水滴可能是高亮区域
                    data[i] = data[i + 1] = data[i + 2] = 255; // 填充为白色
                }
            }

            ctx.putImageData(imageData, 0, 0);
            applyGaussianBlur(canvas); // 增加模糊以平滑污渍
        }

        // 应用高斯模糊
        function applyGaussianBlur(canvas) {
            const ctx = canvas.getContext('2d');
            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            const data = imageData.data;

            const kernel = [
                [1, 2, 1],
                [2, 4, 2],
                [1, 2, 1],
            ];
            const divisor = 16;

            const width = canvas.width;
            const height = canvas.height;
            const blurred = new Uint8ClampedArray(data);

            for (let y = 1; y < height - 1; y++) {
                for (let x = 1; x < width - 1; x++) {
                    let r = 0, g = 0, b = 0;
                    for (let ky = -1; ky <= 1; ky++) {
                        for (let kx = -1; kx <= 1; kx++) {
                            const pixelIndex = ((y + ky) * width + (x + kx)) * 4;
                            const weight = kernel[ky + 1][kx + 1];
                            r += data[pixelIndex] * weight;
                            g += data[pixelIndex + 1] * weight;
                            b += data[pixelIndex + 2] * weight;
                        }
                    }
                    const outputIndex = (y * width + x) * 4;
                    blurred[outputIndex] = r / divisor;
                    blurred[outputIndex + 1] = g / divisor;
                    blurred[outputIndex + 2] = b / divisor;
                }
            }

            imageData.data.set(blurred);
            ctx.putImageData(imageData, 0, 0);
        }

        // 二值化
        function binarizeImage(canvas) {
            const ctx = canvas.getContext('2d');
            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            const data = imageData.data;

            for (let i = 0; i < data.length; i += 4) {
                const gray = data[i];
                const binary = gray > 128 ? 255 : 0;
                data[i] = data[i + 1] = data[i + 2] = binary;
            }

            ctx.putImageData(imageData, 0, 0);
        }

        // OCR 文字识别
        async function extractText(canvas) {
            const { createWorker } = Tesseract;
            const worker = createWorker();

            try {
                await worker.load();
                await worker.loadLanguage('eng+chi_tra'); // 支持中文和英文
                await worker.initialize('eng+chi_tra');
                const result = await worker.recognize(canvas);
                return result.data.text;
            } finally {
                await worker.terminate();
            }
        }
    </script>
</body>
</html>
